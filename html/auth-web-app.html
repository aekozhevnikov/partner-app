<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <link rel="stylesheet" href="/styles/auth.css">
    <link rel="stylesheet" href="/styles/ui-progress-button.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
    <script src="/scripts/progress-button/modernizr.custom.js"></script>

</head>

<body>

    <div class="container">
        <form id="partner-form">

            <div class="input-form">
                <div class="input-label" id="manager-name-label">ФИО</div>
                <input class="input" type="text" id="manager-name" placeholder="Name" required
                    oninput="validateName(event.target)">
                <div class="input-label" id="manager-phone-label">Телефон</div>
                <input class="input" type="tel" id="manager-phone" placeholder="+79999999999" required
                    oninput="formatPhoneNumber(this)">
                <div class="input-label" id="manager-email-label">Email</div>
                <input class="input" type="text" id="manager-email" placeholder="example@mail.com" required
                    pattern="[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+.[a-zA-Z]{2,}">
            </div>
        </form>

        <div class="multiselect_block">
            <label for="select-1" class="field_multiselect">Сферы деятельности</label>
            <input id="checkbox-1" class="multiselect_checkbox" type="checkbox">
            <label for="checkbox-1" class="multiselect_label"></label>
            <select id="field_select-type" class="field_select" multiple>
                <!-- заполняем из таблицы -->
            </select>
        </div>

        <div class="progress-button">

            <button><span>Отправить</span></button>

            <svg class="progress-circle" width="70" height="70">
                <path
                    d="m35,2.5c17.955803,0 32.5,14.544199 32.5,32.5c0,17.955803 -14.544197,32.5 -32.5,32.5c-17.955803,0 -32.5,-14.544197 -32.5,-32.5c0,-17.955801 14.544197,-32.5 32.5,-32.5z" />
            </svg>

            <svg class="checkmark" width="30" height="30">
                <path d="m31.5,46.5l15.3,-23.2" />
                <path d="m31.5,46.5l-8.5,-7.1" />
            </svg>

            <svg class="cross" width="30" height="30">
                <path d="m35,35l-9.3,-9.3" />
                <path d="m35,35l9.3,9.3" />
                <path d="m35,35l-9.3,9.3" />
                <path d="m35,35l9.3,-9.3" />
            </svg>

        </div>
    </div>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="/scripts/progress-button/classie.js"></script>
    <script src="/scripts/progress-button/uiProgressButton.js"></script>
    <script src="/scripts/auth-web-app.js"></script>
    <script>
        var button = document.querySelector('.progress-button');

        new UIProgressButton(button, {
            callback: async function (instance) {
                try {
                    const fields = {
                        name: '#manager-name',
                        phone: '#manager-phone',
                        email: '#manager-email',
                    };

                    const data = Object.fromEntries(
                        Object.entries(fields).map(([key, selector]) => [key, document.querySelector(selector).value])
                    );

                    const buttons = document.querySelectorAll('.btn_multiselect');
                    let buttonValues = [];

                    buttons.forEach(button => {
                        const buttonValue = button.textContent.trim();
                        buttonValues.push(buttonValue);
                    });

                    buttonValues = buttonValues.join(', ');
                    console.log(buttonValues);

                    const { name, phone, email } = data;

                    const response = await fetch(`/savedata?partner=${partner}&user_id=${id}&username=${username}&name=${name}&phone=${phone}&email=${email}&groups=${buttonValues}`);

                    const { success } = await response.json();

                    if (success) {
                        alert('Вы успешно авторизованы');
                    }
                } catch (error) {
                    alert('Ошибка Авторизации');
                    showErrorNotification(error);
                }

                var progress = 0,
                    interval = setInterval(function () {
                        progress = Math.min(progress + Math.random() * 0.1, 1);
                        instance.setProgress(progress);

                        if (progress === 1) {
                            instance.stop(-1); // Остановить с анимацией влево
                            clearInterval(interval);
                        }
                    }, 150);
            }
        });
    </script>
</body>

</html>